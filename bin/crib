#!/bin/bash
: "${CRIB_ROOT:=$(dirname "$(dirname "$(realpath "$0")")")}"
deno run --no-check --allow-env --allow-read --allow-write "$CRIB_ROOT/src/cli.ts" "$@" | {
  read -r L
  case "$L" in
    =fzf=)
      read -r Q # query
      read -r tmpPath # article-map path
      fzf --ansi -q "$Q" --exit-0 --tabstop=4 --prompt='CRIB> ' --delimiter='\t' --with-nth=2.. --nth='2..' \
        --height 64% --preview-window 'down,45%,wrap,border-rounded' \
        --preview "deno run --no-check --allow-read "$CRIB_ROOT/src/previewer.ts" "$(echo "$tmpPath" | sed 's!\\!\\\\\\\\!g')" {1} {2}"
      if [[ -e "$tmpPath" ]]; then
        :
        rm "$tmpPath"
      fi
      ;;
    '') # cliffy --help option
      echo
      cat
      ;;
    *)
      cat
  esac
}
sts=(${PIPESTATUS[@]})
if (( ${sts[0]} ))
then exit ${sts[0]}
fi
exit ${sts[1]}

